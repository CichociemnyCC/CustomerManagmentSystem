@model Client
@{
    ViewData["Title"] = "Edit Client";
}

<h2>Menu Edycji Klienta</h2>

<form asp-action="Edit" method="post" data-val="false">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <input type="hidden" asp-for="Id" />

    <div class="mb-3">
        <label>Nazwa Klienta</label>
        <input asp-for="ClientName" class="form-control" required />
        <span asp-validation-for="ClientName" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Pochodzenie</label>
        <input asp-for="Source" class="form-control" required />
        <span asp-validation-for="Source" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Usługi</label>
        <select name="SelectedServices" class="form-select selectpicker" multiple data-live-search="true" required>
            @foreach (var s in ViewBag.Services as List<string>)
            {
                var selected = (Model?.Services?.Contains(s) == true) ? "selected" : "";
                @:<option value="@s" @selected>@s</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label>Pakiety</label>
        <select name="SelectedPackages" class="form-select selectpicker" multiple data-live-search="true" required>
            @foreach (var p in ViewBag.Packages as List<string>)
            {
             var selected = (Model?.Packages?.Contains(p) == true) ? "selected" : "";
                @:<option value="@p" @selected>@p</option>
            }
        </select>
    </div>
    <div class="mb-3">
        <label>Numer Umowy</label>
        <input asp-for="ContractNumber" class="form-control" />
        <span asp-validation-for="ContractNumber" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Osoba Kontaktowa</label>
        <input asp-for="ContactPerson" class="form-control" />
        <span asp-validation-for="ContactPerson" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Dane Kontaktowe</label>
        <input asp-for="ContactData" class="form-control" />
        <span asp-validation-for="ContactData" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Nadane Dostepy</label>
        <input asp-for="AccessGrantedBy" class="form-control" />
        <span asp-validation-for="AccessGrantedBy" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Konto Meta/ADS</label>
        <input asp-for="MetaAccount" class="form-control" />
        <span asp-validation-for="MetaAccount" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Ustalenia Meta/ADS</label>
        <input asp-for="MetaAgreement" class="form-control" />
        <span asp-validation-for="MetaAgreement" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Dane Lokalne</label>
        <input asp-for="LocalData" class="form-control" />
        <span asp-validation-for="LocalData" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label for="SocialWebGoogleDrive" class="form-label">Sociale / WWW / Dysk Google</label>
        <textarea asp-for="SocialWebGoogleDrive" class="form-control" rows="5" placeholder="Opis 1|https://link1.com&#10;Opis 2|https://link2.com"></textarea>
        <span asp-validation-for="SocialWebGoogleDrive" class="text-danger"></span>
        <small class="form-text text-muted">
            Wpisz każdy link w osobnej linii w formacie: <strong>Opis|https://adres</strong><br />
            Przykład:<br />
            Google Drive|https://drive.google.com/s/abc123<br />
            Strona WWW|https://example.com
        </small>
    </div>
    <div class="mb-3">
        <label>Data Rozpoczęcia Umowy</label>
        <div class="input-group" style="max-width: 250px;">
            <input asp-for="ServiceStartDate" 
                   id="serviceStartDate" 
                   name="ServiceStartDate" 
                   class="form-control" 
                   type="text"  
                  readonly />
           <span class="input-group-text bg-white" id="startIcon" style="cursor: pointer;">
               <i class="bi bi-calendar3" style="font-size: 1.5rem;"></i>
           </span>
       </div>
        <span asp-validation-for="ServiceStartDate" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Data Zakończenia Umowy</label>
        <div class="input-group" style="max-width: 250px;">
            <input asp-for="ServiceEndDate" 
                   id="serviceEndDate" 
                   name="ServiceEndDate" 
                   class="form-control" 
                   type="text"  
                   readonly />
           <span class="input-group-text bg-white" id="endIcon" style="cursor: pointer;">
               <i class="bi bi-calendar3" style="font-size: 1.5rem;"></i>
            </span>
        </div>
        <span asp-validation-for="ServiceEndDate" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label>Dodatkowe Informacje</label>
        <textarea asp-for="Notes" class="form-control"></textarea>
        <span asp-validation-for="Notes" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Zapisz Zmiany</button>
</form>

<a class="btn btn-secondary mt-2" href="@Url.Action("Index")">Wróć do Listy</a>
@section Scripts {
    <script>
        $(function(){
            $("input, textarea").removeAttr("data-val");
            $("input, textarea").removeAttr("data-val-required");
        });
        $(document).ready(function(){
            $('.selectpicker').selectpicker();
        });
    </script>
    <script>
        const startInput = document.getElementById("serviceStartDate");
        const endInput = document.getElementById("serviceEndDate");

        // Funkcja zamienia "dd.mm.yyyy" -> "yyyy-mm-dd"
        function parsePolishDateToIso(dateString) {
            const parts = dateString.split(".");
            if (parts.length !== 3) return null;
            const [day, month, year] = parts;
            return `${year}-${month}-${day}`;
        }

        flatpickr(startInput, {
            altInput: true,
            altFormat: "d.m.Y",
            dateFormat: "Y-m-d",
            allowInput: false,
            defaultDate: parsePolishDateToIso(startInput.value)
        });

        flatpickr(endInput, {
            altInput: true,
            altFormat: "d.m.Y",
            dateFormat: "Y-m-d",
            allowInput: false,
            defaultDate: parsePolishDateToIso(endInput.value)
        });

        // Klik na ikonę otwiera kalendarz
        document.getElementById("startIcon").addEventListener("click", () => {
            document.querySelector("#serviceStartDate")._flatpickr.open();
        });

        document.getElementById("endIcon").addEventListener("click", () => {
            document.querySelector("#serviceEndDate")._flatpickr.open();
        });
    </script>
}

