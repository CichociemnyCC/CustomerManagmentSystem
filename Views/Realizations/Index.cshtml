@model List<Realization>
@using System.Globalization
@{
    ViewData["Title"] = "Realizations";
    var month = ViewBag.SelectedMonth as string;
    var isPrivileged = User.IsInRole("Admin") || User.IsInRole("Dyrektor") || User.IsInRole("Kierownik") || User.IsInRole("Manager");
}

<h2>Realizacje - @month</h2>

<form method="get" class="mb-3 d-flex align-items-center gap-2">
    <input type="month" name="month" value="@month" class="form-control" style="width: 300px"/>
    @{
        var selectedUserId = Context.Request.Query["assignedTo"];
        var users = ViewBag.Users as List<ApplicationUser>;
    }
    
    <select name="assignedTo" class="form-select" style="width: 250px;" onchange="this.form.submit()">
        <option value="">Wszyscy wykonujący</option>
    
        @foreach (var user in users)
       {
            var isSelected = selectedUserId == user.Id ? " selected" : "";
            @Html.Raw($"<option value='{user.Id}'{isSelected}>{user.FirstName} {user.LastName}</option>")
        }
    </select>
    <div style="width: 100px;"></div>
    <label for="pageSize">Wierszy na stronę:</label>
    <select name="pageSize" id="pageSize" class="form-select w-auto" onchange="this.form.submit()">
        <option value="10" selected="@(ViewBag.PageSize == 10 ? "selected" : null)">10</option>
        <option value="25" selected="@(ViewBag.PageSize == 25 ? "selected" : null)">25</option>
        <option value="50" selected="@(ViewBag.PageSize == 50 ? "selected" : null)">50</option>
    </select>
    <input type="hidden" name="page" value="@ViewBag.Page" />
    <button type="submit" class="btn btn-primary">Zmień miesiąc</button>
    <a class="btn btn-outline-dark" href="@Url.Action("Archived", "Realizations")">
        🗄 Zobacz archiwalne realizacje
    </a>
</form>
@{
    int pageSize = ViewBag.PageSize ?? 10;
    int page = ViewBag.Page ?? 1;
    int totalItems = ViewBag.TotalItems ?? 0;

    int startItem = ((page - 1) * pageSize) + 1;
    int endItem = Math.Min(startItem + pageSize - 1, totalItems);
}
<p>Wyświetlane @startItem - @endItem z @totalItems klientów</p>
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>Klient</th>
            <th>Usługi</th>
            <th>Pakiety</th>
            <th>Start</th>
            <th>Koniec</th>
            <th>Status Realizacji</th>
            <th>Osoba Wykonująca</th>
            <th>Akcje</th>
        </tr>
    </thead>
    <tbody>

        @foreach (var r in Model)
        {
            var client = r.Client;
            var today = DateTime.Today;

            bool hasEnded = client.ServiceEndDate.HasValue && client.ServiceEndDate.Value < today;

            <tr>
                @{
                    var editId = ViewBag.EditingId as int?;
                }
                <td>@client.ClientName</td>
                <td>@client.Services</td>
                <td>@client.Packages</td>
                <td>@client.ServiceStartDate?.ToShortDateString()</td>
                <td>@client.ServiceEndDate?.ToShortDateString()</td>
                <td>
                    @if (editId == r.Id)
                    {
                        <form method="post" asp-action="UpdateStatus" class="d-flex gap-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@r.Id" />
                            <input type="hidden" name="month" value="@ViewBag.SelectedMonth" />
                            <input type="hidden" name="assignedTo" value="@Context.Request.Query["assignedTo"]" />
                            <input type="hidden" name="page" value="@ViewBag.Page" />
                            <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                            @{
                                var currentMonth = DateTime.ParseExact(ViewBag.SelectedMonth?.ToString() ?? DateTime.Today.ToString("yyyy-MM"), "yyyy-MM", CultureInfo.InvariantCulture);
                                var statusEntry = r.Statuses?.FirstOrDefault(s => s.Month == currentMonth);
                                var currentStatus = statusEntry?.Status ?? "Brak Danych";
                            }
                            <select name="status" class="form-select">
                                <option selected="@(currentStatus == "Nie można wykonać")">Nie można wykonać</option>
                                <option selected="@(currentStatus == "Nie rozpoczęte")">Nie rozpoczęte</option>
                                <option selected="@(currentStatus == "W trakcie")">W trakcie</option>
                                <option selected="@(currentStatus == "Zakończone")">Zakończone</option>
                                <option selected="@(currentStatus == "Dostępne od następnego Miesiąca")">Dostępne od następnego Miesiąca</option>
                            </select>
                            <button type="submit" class="btn btn-success btn-sm">Zapisz</button>
                            <a href="@Url.Action("Index", new { month = ViewBag.SelectedMonth })" class="btn btn-secondary btn-sm">Anuluj</a>
                        </form>
                    }
                    else
                    {                                           
                         var currentMonth = DateTime.ParseExact(
                            ViewBag.SelectedMonth?.ToString() ?? DateTime.Today.ToString("yyyy-MM"),
                            "yyyy-MM",
                            CultureInfo.InvariantCulture
                        );
                    
                        var statusEntry = r.Statuses?.FirstOrDefault(s => s.Month == currentMonth);
                        var knownStatuses = new[] {
                            "Nie rozpoczęte", "W trakcie", "Zakończone", 
                            "Dostępne od następnego Miesiąca", "Nie można wykonać"
                        };

                        var status = knownStatuses.Contains(statusEntry?.Status)
                           ? statusEntry.Status
                           : "Brak Danych";

                        string badgeClass = status switch
                        {
                            "Nie rozpoczęte" => "bg-danger",
                            "W trakcie" => "bg-warning text-dark",
                            "Zakończone" => "bg-success",
                            "Dostępne od następnego Miesiąca" => "bg-primary",
                            "Nie można wykonać" => "bg-dark text-white",
                            "Brak Danych" => "bg-secondary",
                            _ => "bg-secondary"
                        };
                        <span class="badge @badgeClass">@status</span>
                    }                   
                </td>
                <td>@(r.AssignedUser != null ? $"{r.AssignedUser.FirstName} {r.AssignedUser.LastName}" : "Nieprzypisany")</td>
                <td>
                    @if (ViewBag.EditingId == r.Id)
                    {
                    }
                    else
                    {
                        <form method="get" asp-action="Index" class="d-inline">
                            <input type="hidden" name="editid" value="@r.Id" />
                            <input type="hidden" name="month" value="@ViewBag.SelectedMonth" />
                            <input type="hidden" name="page" value="@ViewBag.Page" />
                            <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                            <input type="hidden" name="assignedTo" value="@ViewBag.SelectedAssignedTo" />
                            <button type="submit" class="btn btn-outline-primary btn-sm">Edytuj</button>
                        </form>
                    }

                    @if (isPrivileged)
                    {
                        <a class="btn btn-sm btn-secondary" asp-action="Assign" asp-route-id="@r.Id">Przypisz</a>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>
<nav>
    <ul class="pagination">
        <li class="page-item @( (ViewBag.Page <= 1) ? "disabled" : "" )">
            <a class="page-link" href="@Url.Action("Index", new { 
                page = (int)ViewBag.Page - 1, 
                pageSize = (int)ViewBag.PageSize,
                month = ViewBag.SelectedMonth,
                assignedTo = ViewBag.SelectedAssignedTo
            })">Poprzednia Strona</a>
        </li>
        <li class="page-item @( ((int)ViewBag.Page * (int)ViewBag.PageSize >= (int)ViewBag.TotalItems) ? "disabled" : "" )">
            <a class="page-link" href="@Url.Action("Index", new { 
                page = (int)ViewBag.Page + 1, 
                pageSize = (int)ViewBag.PageSize,
                month = ViewBag.SelectedMonth,
                assignedTo = ViewBag.SelectedAssignedTo
            })">Następna Strona</a>
        </li>
    </ul>
</nav>

